name: Polaris Security Scan

# Trigger this workflow on pull requests
on:
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened]

jobs:
  polaris-scan:
    name: Polaris SAST Scan
    runs-on: ubuntu-latest
    
    # Only run if it's a pull request
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch full history for accurate comparison
        fetch-depth: 0
        
    - name: Set up environment
      run: |
        echo "Setting up Polaris scan environment"
        echo "PR Number: ${{ github.event.number }}"
        echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
        echo "Head Branch: ${{ github.event.pull_request.head.ref }}"
    
    - name: Download and Setup Bridge CLI
      run: |
        echo "Downloading Synopsys Bridge CLI..."
        curl -fsSL -o bridge.zip ${{ vars.BRIDGECLI_LINUX64 }}
        unzip -qq -d ${{ runner.temp }} bridge.zip
        rm -f bridge.zip
        chmod +x ${{ runner.temp }}/bridge-cli-bundle-linux64/bridge-cli
        echo "Bridge CLI setup complete"
    
    - name: Run Polaris Security Scan
      env:
        # These would be set in your repository secrets/variables
        POLARIS_ACCESS_TOKEN: ${{ secrets.POLARIS_ACCESS_TOKEN }}
        POLARIS_SERVER_URL: ${{ vars.POLARIS_SERVER_URL }}
      run: |
        echo "Starting Polaris security scan..."
        ${{ runner.temp }}/bridge-cli-bundle-linux64/bridge-cli \
          --stage polaris \
          polaris.prcomment.enabled=true \
          polaris.branch.parent.name=${{ github.event.pull_request.base.ref }} \
          github.repository.pull.number=${{ github.event.number }}
    
    - name: Archive Polaris Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: polaris-scan-results
        path: |
          .bridge/
          polaris-results.json
        retention-days: 30
