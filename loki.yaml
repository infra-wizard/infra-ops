# AKS-Optimized Loki Configuration
# This configuration is designed for Azure Kubernetes Service deployment

loki:
  # Azure Blob Storage configuration
  schemaConfig:
    configs:
      - from: "2024-04-01"
        store: tsdb
        object_store: azure
        schema: v13
        index:
          prefix: loki_index_
          period: 24h
  
  # Storage configuration for Azure Blob Storage
  storage:
    type: azure
    azure:
      account_name: ${AZURE_STORAGE_ACCOUNT_NAME}
      account_key: ${AZURE_STORAGE_ACCOUNT_KEY}
      container_name: ${AZURE_STORAGE_CONTAINER_NAME}
      endpoint_suffix: core.windows.net
      max_retries: 3
      timeout: 30s
    bucketNames:
      chunks: loki-chunks
      ruler: loki-ruler
      admin: loki-admin

  # Ingester configuration optimized for AKS
  ingester:
    chunk_encoding: snappy
    chunk_idle_period: 1h
    chunk_target_size: 1048576
    chunk_retain_period: 30s
    max_chunk_age: 1h
    max_transfer_retries: 0
    wal:
      enabled: true
      dir: /var/loki/wal
      checkpoint_duration: 5m
      flush_on_shutdown: true

  # Pattern ingester for advanced log processing
  pattern_ingester:
    enabled: true

  # Limits configuration optimized for AKS
  limits_config:
    allow_structured_metadata: true
    volume_enabled: true
    # Rate limits optimized for AKS
    ingestion_rate_mb: 100          # Increased for AKS capacity
    ingestion_burst_size_mb: 200    # Allow larger bursts
    max_concurrent_tail_requests: 100
    # Timestamp handling
    reject_old_samples: false
    reject_old_samples_max_age: 168h
    # Retention settings
    retention_period: 720h  # 30 days retention
    # Query limits
    max_query_series: 100000
    max_query_parallelism: 32
    max_entries_limit_per_query: 5000
    max_query_length: 721h
    max_query_lookback: 721h


# Deployment mode for AKS
deploymentMode: SimpleScalable

# Backend configuration for AKS
backend:
  replicas: 2  # Increased for HA in AKS

# Read component configuration
read:
  replicas: 2  # Increased for HA

# Write component configuration
write:
  replicas: 2  # Increased for HA and data durability

# Gateway configuration for AKS
gateway:
  service:
    type: ClusterIP
    port: 3100
    targetPort: 8080
