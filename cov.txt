# Create a user-assigned managed identity
az identity create \
  --name github-acr-identity \
  --resource-group <your-resource-group>

# Get the identity details (save these)
az identity show \
  --name github-acr-identity \
  --resource-group <your-resource-group> \
  --query '{clientId:clientId, principalId:principalId}' \
  --output json

# Get ACR resource ID
ACR_ID=$(az acr show --name <your-acr-name> --query id --output tsv)

# Grant AcrPush role (includes pull + push)
az role assignment create \
  --assignee <principalId-from-step-1> \
  --role AcrPush \
  --scope $ACR_ID

# OR grant AcrPull role (only pull access)
az role assignment create \
  --assignee <principalId-from-step-1> \
  --role AcrPull \
  --scope $ACR_ID


# For specific repository and branch
az identity federated-credential create \
  --name github-main-branch \
  --identity-name github-acr-identity \
  --resource-group <your-resource-group> \
  --issuer https://token.actions.githubusercontent.com \
  --subject repo:<your-org>/<your-repo>:ref:refs/heads/main \
  --audiences api://AzureADTokenExchange

# For pull requests (if needed)
az identity federated-credential create \
  --name github-pull-requests \
  --identity-name github-acr-identity \
  --resource-group <your-resource-group> \
  --issuer https://token.actions.githubusercontent.com \
  --subject repo:<your-org>/<your-repo>:pull_request \
  --audiences api://AzureADTokenExchange

# For all branches (use with caution)
az identity federated-credential create \
  --name github-all-branches \
  --identity-name github-acr-identity \
  --resource-group <your-resource-group> \
  --issuer https://token.actions.githubusercontent.com \
  --subject repo:<your-org>/<your-repo>:ref:refs/heads/* \
  --audiences api://AzureADTokenExchange


# Get tenant and subscription IDs
az account show --query '{tenantId:tenantId, subscriptionId:id}' --output json


- name: Azure Login using OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Login to ACR
        run: |
          az acr login --name <your-acr-name>

- name: Build Docker image
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/myapp:${{ github.sha }} .
          docker tag ${{ secrets.ACR_LOGIN_SERVER }}/myapp:${{ github.sha }} \
                     ${{ secrets.ACR_LOGIN_SERVER }}/myapp:latest
      
      - name: Push to ACR
        run: |
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/myapp:${{ github.sha }}
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/myapp:latest


- name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash



az identity federated-credential create \
  --name github-all-branches \
  --identity-name github-acr-identity \
  --resource-group <your-resource-group> \
  --issuer https://token.actions.githubusercontent.com \
  --subject repo:Mohammed-Asher/aks-cicd-test:ref:refs/heads/* \
  --audiences api://AzureADTokenExchange
